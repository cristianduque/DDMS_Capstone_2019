<!DOCTYPE html>
<html lang="en" dir="ltr">
    <meta charset="utf-8">
    <title>Planning</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src = "https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <style>
        #app {
            font-family: 'Avenir', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-align: center;
            color: #2c3e50;
            margin-top: 60px;
        }
        body {
            background-color: #EEEEEE;
            font-family: 'Montserrat', sans-serif;
            display: grid;
            grid-template-rows: auto;
            justify-items: center;
            padding-top: 50px;
        }
        nav {
            padding: 20px 20px 20px 0;
        }
        nav a {
            padding: 25px;
            text-decoration: none;
            background: #fff;
            border-radius: 3px;
            color: rgb(0, 110, 255);
            font-weight: bold;
            margin-right: 45px;
            font-size: 35px;
        }

        .date-hour {
            text-align: center;
            margin-top: 50pt;
        }

        .events {
            text-align: center;
            margin-top: 50pt;
        }

        .event-list {
            text-align: left;
        }

        .buttons-manage-event {
            text-align: right;
        }

        .client {
            line-height: 40pt;
            padding-bottom:  auto !important;
            text-align: center !important;
        }

        .demonstrator {
            line-height: 30pt;
            padding-bottom: auto !important;
            text-align: center !important;
        }

        .products {
            line-height: 30pt;
            padding-bottom: auto !important;
            text-align: center !important;
        }

        .multiplier {
            line-height: 30pt;
            padding-bottom: auto !important;
            text-align: center !important;
        }

        .approval {
            line-height: 30pt;
            padding-bottom: auto !important;
            text-align: center !important;
        }
        .nav-planning {
            line-height: 30pt;
        }

        .name-demo {
            text-align: center;
            margin-top: 100pt;
        }
    </style>
</head>
<body>
<div id="app">
<v-app></v-app>

</div>

<script>
    var Planning = Vue.component('Planning', {
        data: function (){
            return{
                count:0
            }
        },
        template: `
        <div>
    <img alt="La Aguadillana logo" src="https://aguadillana.sharepoint.com/DDMS/Shared%20Documents/img/DDMSLogo.png">

    <v-bottom-nav class="nav-planning" color="teal">
        <!--<router-link to = "/">Home</router-link>-->
        <v-btn color="teal" to = "/CreateEvent"> Create Event

        </v-btn>
        <v-btn color="teal" to = "/ManageEvent"> Manage Event

        </v-btn>

    </v-bottom-nav>
    </div>
        `
    });
    var CreateEvent = Vue.component('CreateEvent', {
        data: function () {
            return {
                clients:[],
                products: [],
                demonstrators: [],
                employees: [],
                events: [],
                postData: [],
                requestDigest: ""
            }
        },
        created: function(){
            this.handlerData();
        },
        template: `<form class="planning-form">

        <div class="name-demo">
            <h3> Seleccione nombre de la demostracion: </h3>
                  <input id="name-demo-text" type="text">
        </div>

        <div class="date-hour">
            <h3> Seleccione la fecha y hora de la demostracion:</h3>
                  <input id="date-selected" type="datetime-local" v-on:change="handlerAlerts">
        </div>

        <div class="client">
            <h3>Seleccione el cliente:</h3>
                <select id="clientList" v-on:change="checkClientConflict">
                    <option disabled value="">Escoja uno</option>
                    <option value="client" v-for="client in clients">{{client.Title}}</option>
                </select>
        </div>

        <div class="demonstrator">
            <h3>Seleccione la demostradora:</h3>
                <select id="demList" v-on:change="checkDemonstratorConflict">
                    <option disabled value="">Escoja uno</option>
                    <option value="demonstrator" v-for="item in demonstrators" v-if="item.bevs ==='DEMO'">{{item.vblv}}</option>
                </select>
        </div>

        <div class="products">
            <h3>Seleccione los productos:</h3>
            <v-list>
                <li v-for="product in products">
                  <input name="checkProducts" type="checkbox" v-bind:value="product.e9lf"> {{product.e9lf}}
                </li>
            </v-list>
        </div>

        <div class="multiplier">
            <h3> Seleccione el multiplicador: </h3>
                    <input id="multiplier-num" type="number">
        </div>

        <div class="approval">

            <h3> Seleccione las personas que seran parte del proceso de aprobacion:</h3>
                    <select id="first-employee"> 1.
                        <option disabled value="">Escoja uno</option>
                        <option v-for="item in employees" v-if="item.bevs ==='SUPERVISOR'"> {{item.vblv}} </option>
                    </select>
                <br/>
                    <select id="second-employee"> 2.
                        <option disabled value="">Escoja uno</option>
                        <option v-for="item in employees" v-if="item.bevs ==='SUPERVISOR'"> {{item.vblv}} </option>
                    </select>
                <br/>
                    <select id="third-employee"> 3.
                        <option disabled value="">Escoja uno</option>
                        <option v-for="item in employees" v-if="item.bevs ==='SUPERVISOR'"> {{item.vblv}}</option>
                    </select>
            </h1>
        </div>

        <div class="buttons">
            <button v-on:click="addEvent"> Add event</button>
            <v-btn color="teal" href="/sites/DDMS/Shared%20Documents/planning.aspx#/"> Cancel event</v-btn>
        </div>

    </form>

        `,
        methods:{
            getClientListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Clients')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.clients = response.data.value;
                });
            },
            getProductListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Product')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.products = response.data.value;
                });
            },
            getDemonstratorListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Employee')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.demonstrators = response.data.value;
                });
            },
            getApprovalListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Employee')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.employees = response.data.value;
                });
            },
            getEventListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Events')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.events = response.data.value;
                });
            },
            checkClientConflict: function(){
                for (var j = 0; j < this.events.length; j++){
                    var temp = document.getElementById("clientList");
                    var eClient = temp.options[temp.selectedIndex].text;

                    var temp1 = document.getElementById("date-selected").value;
                    var temp2 = new Date(temp1);
                    temp2.setHours(temp2.getHours() - 4);
                    var eDate = temp2.toISOString();

                    var date = new Date(this.events[j].event_date);
                    date.setHours(date.getHours() - 3);

                    // now you can get the string
                    var isodateList = date.toISOString();

                    console.log(isodateList);
                    console.log(this.events[j].event_client);

                    if(this.events[j].event_client == eClient && isodateList == eDate){
                            alert("El cliente escogido tiene demostracion en la fecha escogida. Escoja otro cliente");
                    }
                }
            },
            checkDemonstratorConflict: function(){
                for (var j = 0; j < this.events.length; j++){
                    var temp = document.getElementById("demList");
                    var eDemonstrator = temp.options[temp.selectedIndex].text;

                    var temp1 = document.getElementById("date-selected").value;
                    var temp2 = new Date(temp1);
                    temp2.setHours(temp2.getHours() - 4);
                    var eDate = temp2.toISOString();

                    var date = new Date(this.events[j].event_date);
                    date.setHours(date.getHours() - 3);

                    // now you can get the string
                    var isodateList = date.toISOString();

                    console.log(isodateList);
                    console.log(this.events[j].event_client);

                    if(this.events[j].event_demonstrator == eDemonstrator && isodateList == eDate){
                        alert("La demostradora escogida tiene demostracion en la fecha escogida. Escoja otra demostradora");
                    }
                }
            },
            addEvent: function(){
                //FORM the Data to POST
                var name = document.getElementById("name-demo-text").value;

                //Date
                var temp1 = document.getElementById("date-selected").value;
                var temp2 = new Date(temp1);
                temp2.setHours(temp2.getHours() - 1);
                var date = temp2.toISOString();

                //Client
                var temp = document.getElementById("clientList");
                var client = temp.options[temp.selectedIndex].text;

                //Demonstrator
                var temp3 = document.getElementById("demList");
                var demonstrator = temp3.options[temp3.selectedIndex].text;

                //Products
                var checkboxes = document.getElementsByName("checkProducts");
                var checkedProducts = "";

                console.log(checkboxes);

                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].type =='checkbox' && checkboxes[i].checked == true){
                        checkedProducts+=checkboxes[i].value+",";
                    }
                }

                console.log(checkedProducts);

                //Muliplier
                var multiplier = document.getElementById("multiplier-num").value;

                //Event Approver 1
                var tempApprover1 = document.getElementById("first-employee");
                var approver1 = tempApprover1.options[tempApprover1.selectedIndex].text;

                //Event Approver 2
                var tempApprover2 = document.getElementById("second-employee");
                var approver2 = tempApprover2.options[tempApprover2.selectedIndex].text;

                //Event Approver 3
                var tempApprover3 = document.getElementById("third-employee");
                var approver3 = tempApprover3.options[tempApprover3.selectedIndex].text;

                //Event Id
                var event_id = this.events.length.toString();

                if(name === null || date === null || client === null || demonstrator === null || checkedProducts === null || multiplier === null || approver1 === null){
                    alert("El formulario esta con campos vacios. Verifique que todo campo este lleno");
                    return;
                }

                $.ajax({
                    async: true,
                    url: "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Events')/items",
                    method: "POST",
                    data: JSON.stringify({
                        '__metadata': {
                            'type': 'SP.Data.EventsListItem' // it defines the ListEntityTypeName
                        },
                        "Title": name,
                        "event_id": event_id,
                        "event_date": date,
                        "event_client": client,
                        "event_demonstrator": demonstrator,
                        "products": checkedProducts,
                        "event_mult": multiplier,
                        "event_approver1": approver1,
                        "event_approver2": approver2,
                        "event_approver3": approver3,
                        "Event_Status": 'AGENDA'
                    }),
                    headers: {
                        "accept": "application/json;odata=verbose",
                        "content-type": "application/json;odata=verbose",
                        "X-RequestDigest":"0x05AE654D376174F16F599EB1DEDAB36441DC7B9FF3F55FCE271B6D043849A4F788B83C32523BBC3AD95409C9BE57570A51A7379091BA4BB36D8217752E69D6B5,07 Apr 2019 17:57:04 -0000"
                        //"Cookie": "FedAuth=77u/PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48U1A+VjUsMGguZnxtZW1iZXJzaGlwfDEwMDMyMDAwM2NlMjFmNzNAbGl2ZS5jb20sMCMuZnxtZW1iZXJzaGlwfGNhcHN0b25lQGxhYWd1YWRpbGxhbmEuY29tLDEzMTk5MTIzNjkwMDAwMDAwMCwxMzE5NTA2MjUwMzAwMDAwMDAsMTMxOTkyMTAxMDc5MDU1MjkwLDAuMC4wLjAsMixmNDRiNzA4OC0xNTc5LTQ3OWUtYTQ3NS1iZmQyYjQ2MDI0OWEsLCxhZWE4ZDA5ZS00MDc4LTgwMDAtOTk5NS1kODc2MTViMDEyOGYsYWVhOGQwOWUtNDA3OC04MDAwLTk5OTUtZDg3NjE1YjAxMjhmLCwwLDAsMCwsYmJXUStQWDUwekRyWHhBLzdOcHhlM0JpS0FaZEtrMTRNRGtFOW9GWUQ2aE9QZFBqMTZIUlVIOGRjWWRnOGVkT0doM2p6VVduZkY4U25MRDRPTW9LQTFFVWZ0UzhENUNkc1lheHg1OGdKSUo2U1ZoTjJlT3VHcmM4M2pISFREQ0xVdmVrTEgzMFJBWVpkU2xicmFmc0grVkV1TWhjN2l2ZThwWE5Kc3djWDJxbS9OWEVKREhBVC9NZk9OTTd3MzEzaVBxWmJXT2hETkx1Z2orMTJ3SE83M3NwRkorOHQxYllTOEJxU0hqQURuWVFrV2lRdVY4aHBWL011ekNJSU4zSXpKNVdodHA4c1YwTjNxTUhpTFluZEJUT245MzVud1ljRHUyVE5yaTZsWGE4NUhXb0ZkbDdiazljQ1FVUDUxcUFmRXNBZldzU2Z6UEluK2dhRGN4UnJnPT08L1NQPg==; path=/; secure; HttpOnly",
                        //"Cookie": "rtFa=ibALGjJdBQDSLFH1z9kQ0+CkjjfKKbdDQnfCAHKKjzcmRjQ0QjcwODgtMTU3OS00NzlFLUE0NzUtQkZEMkI0NjAyNDlBr0JITHJLD45lVwPZQR5mn5F95FfVvEqF0WrL2388U7Czs5a7Yz8P0CCCj7llogci6rPTv3DAri+iLcdArQQ/rKlHCc7UNZyiF0UKRP8iDtyrwayhlMlkpXCr8VqTybmiQ3cdK71Odk9PdfQkPXw5O5Re+RrY7bkGLXuHh1T4KYLw/5qLsKgT1Jj/DQS6owOquGRVvTe+Trte1Eioz7mKBgQN5e0Gkb06+NDdtInIRAjevi5ot7BIgeb0bSvz9EGCtVO9xlzmm3n2PN7wuJR7NDp22U9XkJ3G0NoNWHwWaR12+wgGZLYZ2ds68BsSl77XmIUAOV4mCui1yTaXkoeFn0UAAAA=; domain=sharepoint.com; path=/; secure; HttpOnly"
                    },
                    success: function(data) {
                        console.log("Item created successfully");
                    },
                    error: function(error) {
                        console.log(JSON.stringify(error));
                    }
                });
            },
            getRequestDigest: function(){
                var vm = this;
                axios.post("https://aguadillana.sharepoint.com/sites/DDMS/_api/contextinfo")
                    .then(response => {
                        console.log(response);
                        vm.requestDigest = response.data.FormDigestValue;
                        console.log(this.requestDigest);
                    })
                    .catch(function (error) {
                        console.log(error);
                        console.log("failed");
                    });
            },
            handlerAlerts: function(){
                this.checkDemonstratorConflict();
                this.checkClientConflict();
            },
            handlerData: function () {
                this.getProductListData();
                this.getClientListData();
                this.getDemonstratorListData();
                this.getApprovalListData();
                this.getEventListData();
                //this.getRequestDigest();
            }
        }
    });
    var ManageEvent =  Vue.component('ManageEvent', {
        data: function (){
            return{
                eventList:[],
                eventTitle: null,
                editEventInfo: []
            }
        },
        created: function(){
            this.handlerManageEventData();
        },
        template: `
        <div class="events">

            <v-btn color="teal" id="edit-btn" v-on:click="getEventEditData" to="/EditEvent"> Edit Demo </v-btn>
            <v-btn color="teal" id="del-btn"> Delete Demo </v-btn>

            <form class="event-list">
                <h3>Demostraciones en agenda: </h3>

                <ul>
                    <li v-for="item in eventList">
                      <input type="radio" id="demos" name="demos" v-bind:value="item.Title" v-on:change="getEventEditTitle"> {{item.Title}}
                    </li>
                </ul>
            </form>
        </div>
        `,
        methods:{
            getEventListData: function () {
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Events')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.eventList = response.data.value;
                });
            },
            getEventEditTitle: function(){
               this.eventTitle = document.querySelector('input[name="demos"]:checked').value;
               console.log(this.eventTitle);

            },
            getEventEditData: function(){
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Events')/items?$filter=Title eq '" + this.eventTitle + "'";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.editEventInfo = response.data.value;
                });
            },
            handlerManageEventData: function() {
                this.getEventListData();
                this.getEventEditData();
            }
        }
    });

    var EditEvent =  Vue.component('EditEvent', {
        data: function (){
            return{
                eventList:[]
            }
        },
        components:{
            ManageEvent
        },
        props:[this.editEventInfo],
        template: `
        <form class="edit-form">

            <div class="date-hour">
                <h3> Seleccione la fecha y hora de la demostracion:</h3>
                      <input id="date-selected" type="datetime-local" v-on:change="handlerAlerts" v-bind:value="editEventInfo[0].event_date">
            </div>

            <div class="client">
                <h3>Seleccione el cliente:</h3>
                    <select id="clientList" v-on:change="checkClientConflict">
                        <option disabled value=""> Escoja uno </option>
                        <option value="client" v-for="client in clients">{{client.Title}}</option>
                        <option value="client" selected>{{editEventInfo[0].event_client}}</option>
                    </select>
            </div>


         </form>
        `,
        methods:{
            getEventFormData: function(){
                var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Events')/items";
                console.log(endPointUrl);
                var headers = {
                    "accept": "application/json;odata=verbose",
                    "content-type": "application/json;odata=verbose"
                };
                this.status = "getting data...";
                var vm = this;
                axios.get(endPointUrl).then(response => {
                    console.log(response.data.value);
                    vm.eventList = response.data.value;
                });
            }
        }
    });

    const routes = [
        //{ path: '/', component: Home},
        { path: '/Planning', component: Planning},
        { path: '/CreateEvent', component: CreateEvent},
        { path: '/ManageEvent', component: ManageEvent},
        { path: '/EditEvent', component: EditEvent}
    ];
    const router = new VueRouter({
        routes // short for `routes: routes`
    });

    var vueApp = new Vue({
        el: "#app",
        template: '<div>\n        <Planning />\n        <router-view></router-view> \n\n        </div>',
        router,
        components:{
            CreateEvent,
            ManageEvent,
            EditEvent,
            Planning
        },
        data(){
            return { reactive: true }

        }
    });

</script>

</body>
</html>
