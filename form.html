<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Formulario de Costos Misceláneos</title>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
	  <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
	  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>

<style>
  .submit_button, .save_button, .cancel_button{
   display: inline-block;
   }
</style>

<body>
  <div id="app">
    <v-app>
      <v-container fluid>
        <v-layout row wrap>
          <v-flex>
            <v-toolbar color="red" dark>
              <v-toolbar-title >Costos Misceláneos</v-toolbar-title>
              <v-spacer></v-spacer>
            </v-toolbar>
            <v-form>
              <v-card>
                <v-card-title primary-title>
                  <h4>Información de Artículos</h4>
                </v-card-title>
                <v-card-text>
                  <span id="article_info" v-for="n in fieldList" >
                    <v-select label="Artículo" :readonly="!inputShow" :items="items" v-model="n.articulo" required></v-select>
                    <v-text-field label="Cantidad(pqt.)" :readonly="!inputShow"  type="number" v-model="n.cantidad" required></v-text-field>
                    <v-text-field label="Precio" :readonly="!inputShow" @blur="calculateTotal" prefix="$" type="number" step=".01" v-model="n.precio" required></v-text-field>
                  </span>
                    <v-text-field label="Total" v-model="total" prefix="$" type="number" readonly></v-text-field>
                </v-card-text>
                <v-card-actions>
                  <div class="add_button" :hidden="!inputShow">
          					<v-btn type="button" @click="addFields">Añadir otro Artículo</v-btn>
          				</div>
                </v-card-actions>
              </v-card>
              <br>
              <v-card>
                <v-card-title>
                  <h4>Evidencia</h4>
                </v-card-title>
                <v-card-text>
                  <v-img
                  :src="src"
                  aspect-ratio="1"
                  class="grey lighten-2"
                ></v-img>
                  <input :hidden="!inputShow" type="file" id="evidence" name="article_evidence" accept="image/*" multiple required>
                </v-card-text>
                <v-card-actions>
									<div :hidden="!inputShow">
                  	<v-btn type="button" @click="deletePhoto">Borrar Foto</v-btn>
									</div>
                </v-card-actions>
              </v-card>
              <br>
              <v-card>
                <v-card-title>
                  <h4>Acción</h4>
                </v-card-title>
                <v-card-actions>
                  <span id="demonstrator" :hidden="!inputShow">
                    <div class="cancel_button">
                      <v-btn type="button" @click="	getRequestDigestValue">Cancelar</v-btn >
                    </div>
                    <div class="save_button">
              				<v-btn  type="button" @click="alert('save')">Guardar</v-btn >
              			</div>
                    <div class="submit_button">
              				<v-btn type="button" @click="alert('submit')">Someter</v-btn >
              			</div>
                  </span>
                  <div class="edit_button" :hidden="inputShow">
              			<v-btn @click="inputShow=true" type="button">Editar</v-btn>
              		</div>
                </v-card-actions>
              </v-card>
            </v-form>
          </v-flex>
        </v-layout>
      </v-container>
    </v-app>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
</body>
</html>

<script type="text/javascript">
  var vueApp = new Vue({
    el:"#app",
    data: {
  		 //message: "Hello World!!!"
  		 fieldList: [{
  			 articulo: "",
  			 cantidad: "",
  			 precio: ""
  		 }],
  		 items: [
  			 "Palillos",
  			 "Servilletas",
  			 "Aceite",
  			 "Platos"
  		 ],
  		 inputShow: false,
       total: "",
       src: `https://aguadillana.sharepoint.com/sites/DDMS/Shared%20Documents/Robie_House.jpg`,
			 Status:"",
			 RequestDigest:"",
			 listData: [],
  	},
    methods:{
      addFields: function(){
  			var elem = document.getElementById('info');
  			//var space = document.createElement('br');
  			//elem.appendChild(space);
  			this.fieldList.push({
  				articulo: "",
  				cantidad: "",
  				precio: ""
  			});
  			console.log(this.fieldList);
  		},

  		calculateTotal: function(){
  			this.total = 0;
  			for(var i = 0; i<this.fieldList.length; i++){
  				this.total = this.fieldList[i].cantidad * this.fieldList[i].precio + this.total;
  			};
        console.log(this.total)
  		},

      alert: function(text){
  			if(text == 'cancel'){
  				swal("Warning!!!","Are you sure you want to cancel the form?", "warning",{
  					buttons: ["No","Yes"]
  				});
  			}else if(text == 'submit'){
					if(this.src != ''){
						swal("Warning!!!","Are you sure you want to submit the form?", "warning",{
							buttons: ["No","Yes"]
						})
						.then((willSend) =>{
							if(willSend){
								this.Status="Submitted";
								this.postListData();
								window.open('mailto:test@example.com?subject=Form%20Submission&body=Demostradora%20ha%20sometido%20un%20formulario');
							}else{
								swal("Check the form for any errors or missing information");
							}
						})
					}else{
						swal("Warning!!!","Cannot submit form without photo evidence", "error");
					}
  			}else{
  				swal("Warning!!!","Are you sure you want to save the form?", "warning",{
  				buttons: ["No","Yes"]
  				})
					.then((willSave) =>{
						if(willSave){
							this.Status="Saved";
							this.postListData();
						}else{
							swal("Check the form for any errors or missing information");
						}
					})
  			}
  		},

      deletePhoto: function(){
        this.src='';
      },

			getRequestDigestValue: function(){
         var headers ={
           "Cookie": "FedAuth=77u/PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48U1A+VjUsMGguZnxtZW1iZXJzaGlwfDEwMDMyMDAwM2NlMjFmNzNAbGl2ZS5jb20sMCMuZnxtZW1iZXJzaGlwfGNhcHN0b25lQGxhYWd1YWRpbGxhbmEuY29tLDEzMTk5MTIzNjkwMDAwMDAwMCwxMzE5NTA2MjUwMzAwMDAwMDAsMTMxOTkyMTAxMDc5MDU1MjkwLDAuMC4wLjAsMixmNDRiNzA4OC0xNTc5LTQ3OWUtYTQ3NS1iZmQyYjQ2MDI0OWEsLCxhZWE4ZDA5ZS00MDc4LTgwMDAtOTk5NS1kODc2MTViMDEyOGYsYWVhOGQwOWUtNDA3OC04MDAwLTk5OTUtZDg3NjE1YjAxMjhmLCwwLDAsMCwsYmJXUStQWDUwekRyWHhBLzdOcHhlM0JpS0FaZEtrMTRNRGtFOW9GWUQ2aE9QZFBqMTZIUlVIOGRjWWRnOGVkT0doM2p6VVduZkY4U25MRDRPTW9LQTFFVWZ0UzhENUNkc1lheHg1OGdKSUo2U1ZoTjJlT3VHcmM4M2pISFREQ0xVdmVrTEgzMFJBWVpkU2xicmFmc0grVkV1TWhjN2l2ZThwWE5Kc3djWDJxbS9OWEVKREhBVC9NZk9OTTd3MzEzaVBxWmJXT2hETkx1Z2orMTJ3SE83M3NwRkorOHQxYllTOEJxU0hqQURuWVFrV2lRdVY4aHBWL011ekNJSU4zSXpKNVdodHA4c1YwTjNxTUhpTFluZEJUT245MzVud1ljRHUyVE5yaTZsWGE4NUhXb0ZkbDdiazljQ1FVUDUxcUFmRXNBZldzU2Z6UEluK2dhRGN4UnJnPT08L1NQPg==; path=/; secure; HttpOnly",
           "Cookie": "rtFa=ibALGjJdBQDSLFH1z9kQ0+CkjjfKKbdDQnfCAHKKjzcmRjQ0QjcwODgtMTU3OS00NzlFLUE0NzUtQkZEMkI0NjAyNDlBr0JITHJLD45lVwPZQR5mn5F95FfVvEqF0WrL2388U7Czs5a7Yz8P0CCCj7llogci6rPTv3DAri+iLcdArQQ/rKlHCc7UNZyiF0UKRP8iDtyrwayhlMlkpXCr8VqTybmiQ3cdK71Odk9PdfQkPXw5O5Re+RrY7bkGLXuHh1T4KYLw/5qLsKgT1Jj/DQS6owOquGRVvTe+Trte1Eioz7mKBgQN5e0Gkb06+NDdtInIRAjevi5ot7BIgeb0bSvz9EGCtVO9xlzmm3n2PN7wuJR7NDp22U9XkJ3G0NoNWHwWaR12+wgGZLYZ2ds68BsSl77XmIUAOV4mCui1yTaXkoeFn0UAAAA=; domain=sharepoint.com; path=/; secure; HttpOnly"
         };
         var vm = this;
         axios.post("https://aguadillana.sharepoint.com/sites/DDMS/_api/contextinfo",headers)
         .then(response => {
           console.log(response);
           vm.RequestDigest = response.data.FormDigestValue
         })
         .catch(function (error) {
           console.log(error);
           console.log("failed");
         });
   		},

			getListData: function(){
				var endPointUrl = "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Receipt')/items";
				var headers = {
					"accept": "application/json;odata=verbose",
					"content-type": "application/json;odata=verbose"
				};
				this.status = "getting data...";
				var vm = this;
				axios.get(endPointUrl).then(response => {
					console.log(response.data.value);
					vm.listData = response.data.value;
					//vm.fieldList[0].articulo = vm.listData[4].receipt_product;
					//vm.total = vm.listData[4].OData__x0073_mm7;
					//vm.fieldList[0].precio = vm.listData[4].reciept_price;
					//vm.fieldList[0].cantidad = vm.listData[4].oazj;
				});
			},

			postListData: function(){
				$.ajax({
     			async: true,
     			url: "https://aguadillana.sharepoint.com/sites/DDMS/_api/web/lists/getbyTitle('Receipt')/items",
     			method: "POST",
     			data: JSON.stringify({
         		'__metadata': {
          		'type': 'SP.Data.ReceiptListItem' // it defines the ListEntityTypeName
         		},
         		"receipt_product": this.fieldList[0].articulo,
						"reciept_price": this.fieldList[0].precio,
						"OData__x0073_mm7": this.total,
						"oazj":this.fieldList[0].cantidad,
						"Receipt_Status":this.Status,
     			}),
     			headers: {
        		"accept": "application/json;odata=verbose",
        		"content-type": "application/json;odata=verbose",
        		"X-RequestDigest": this.RequestDigest
        		//"Cookie": "FedAuth=77u/PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48U1A+VjUsMGguZnxtZW1iZXJzaGlwfDEwMDMyMDAwM2NlMjFmNzNAbGl2ZS5jb20sMCMuZnxtZW1iZXJzaGlwfGNhcHN0b25lQGxhYWd1YWRpbGxhbmEuY29tLDEzMTk5MTIzNjkwMDAwMDAwMCwxMzE5NTA2MjUwMzAwMDAwMDAsMTMxOTkyMTAxMDc5MDU1MjkwLDAuMC4wLjAsMixmNDRiNzA4OC0xNTc5LTQ3OWUtYTQ3NS1iZmQyYjQ2MDI0OWEsLCxhZWE4ZDA5ZS00MDc4LTgwMDAtOTk5NS1kODc2MTViMDEyOGYsYWVhOGQwOWUtNDA3OC04MDAwLTk5OTUtZDg3NjE1YjAxMjhmLCwwLDAsMCwsYmJXUStQWDUwekRyWHhBLzdOcHhlM0JpS0FaZEtrMTRNRGtFOW9GWUQ2aE9QZFBqMTZIUlVIOGRjWWRnOGVkT0doM2p6VVduZkY4U25MRDRPTW9LQTFFVWZ0UzhENUNkc1lheHg1OGdKSUo2U1ZoTjJlT3VHcmM4M2pISFREQ0xVdmVrTEgzMFJBWVpkU2xicmFmc0grVkV1TWhjN2l2ZThwWE5Kc3djWDJxbS9OWEVKREhBVC9NZk9OTTd3MzEzaVBxWmJXT2hETkx1Z2orMTJ3SE83M3NwRkorOHQxYllTOEJxU0hqQURuWVFrV2lRdVY4aHBWL011ekNJSU4zSXpKNVdodHA4c1YwTjNxTUhpTFluZEJUT245MzVud1ljRHUyVE5yaTZsWGE4NUhXb0ZkbDdiazljQ1FVUDUxcUFmRXNBZldzU2Z6UEluK2dhRGN4UnJnPT08L1NQPg==; path=/; secure; HttpOnly",
        		//"Cookie": "rtFa=ibALGjJdBQDSLFH1z9kQ0+CkjjfKKbdDQnfCAHKKjzcmRjQ0QjcwODgtMTU3OS00NzlFLUE0NzUtQkZEMkI0NjAyNDlBr0JITHJLD45lVwPZQR5mn5F95FfVvEqF0WrL2388U7Czs5a7Yz8P0CCCj7llogci6rPTv3DAri+iLcdArQQ/rKlHCc7UNZyiF0UKRP8iDtyrwayhlMlkpXCr8VqTybmiQ3cdK71Odk9PdfQkPXw5O5Re+RrY7bkGLXuHh1T4KYLw/5qLsKgT1Jj/DQS6owOquGRVvTe+Trte1Eioz7mKBgQN5e0Gkb06+NDdtInIRAjevi5ot7BIgeb0bSvz9EGCtVO9xlzmm3n2PN7wuJR7NDp22U9XkJ3G0NoNWHwWaR12+wgGZLYZ2ds68BsSl77XmIUAOV4mCui1yTaXkoeFn0UAAAA=; domain=sharepoint.com; path=/; secure; HttpOnly"
     			},
     			success: function(data) {
         		console.log("Item created successfully");
						swal("Info Succesfully Entered to List", {icon:"success"})
         		//this.getListData();
     			},
     			error: function(error) {
         		console.log(JSON.stringify(error));
     			}
				});
   		}
    }
  })
</script>
